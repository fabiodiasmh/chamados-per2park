name: Build, Push & Deploy Docker Image with Rollback

on:
  push:
    branches: ["main"]
  workflow_dispatch:

env:
  APP_NAME: per2park-app-chamados
  REGION: ${{ secrets.OCI_REGION }}
  TENANCY: grolj6ywhill
  IMAGE_BASE: ${{ secrets.OCI_REGION }}.ocir.io/grolj6ywhill/per2park-app-chamados

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout código
        uses: actions/checkout@v4

      - name: Configurar versão automática
        id: version
        run: |
          SHORT_SHA=$(echo "${GITHUB_SHA}" | cut -c1-7)
          VERSION="v1.0.${GITHUB_RUN_NUMBER}-${SHORT_SHA}"
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "Versão gerada: $VERSION"

      - name: Configurar JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Build do projeto com Maven
        run: |
          mvn clean package -DskipTests

      - name: Login no OCIR
        run: |
          echo "${{ secrets.OCI_AUTH_TOKEN }}" | docker login \
            ${{ env.REGION }}.ocir.io \
            -u "${{ secrets.OCI_USER }}" \
            --password-stdin

      - name: Salvar versão anterior
        id: previous
        run: |
          echo "Salvando imagem anterior..."
          docker pull ${{ env.IMAGE_BASE }}:latest || echo "Sem imagem anterior"
          docker tag ${{ env.IMAGE_BASE }}:latest previous_backup:latest || echo "Nenhuma imagem anterior para backup"

      - name: Build da imagem Docker
        run: |
          docker build -t ${{ env.IMAGE_BASE }}:latest .
          docker tag ${{ env.IMAGE_BASE }}:latest ${{ env.IMAGE_BASE }}:${{ env.VERSION }}

      - name: Push das imagens para OCIR
        run: |
          docker push ${{ env.IMAGE_BASE }}:latest
          docker push ${{ env.IMAGE_BASE }}:${{ env.VERSION }}

      - name: Exibir versão final publicada
        run: |
          echo "Imagem publicada com sucesso:"
          echo "${{ env.IMAGE_BASE }}:${{ env.VERSION }}"

  deploy:
    runs-on: ubuntu-latest
    needs: build-and-push

    steps:
      - name: Conectar via SSH e atualizar containers
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            echo "=== Realizando deploy do container ==="
            cd /home/ubuntu/chamados-stack  # <- ajuste o caminho do seu projeto
            echo "Logando no OCIR..."
            echo "${{ secrets.OCI_AUTH_TOKEN }}" | docker login \
              ${{ env.REGION }}.ocir.io \
              -u "${{ secrets.OCI_USER }}" \
              --password-stdin
            echo "Atualizando containers..."
            docker compose down
            docker compose pull
            docker compose up -d
            docker image prune -f
            echo "Deploy concluído com sucesso ✅"

  rollback:
    runs-on: ubuntu-latest
    needs: build-and-push
    if: failure()

    steps:
      - name: Login no OCIR
        run: |
          echo "${{ secrets.OCI_AUTH_TOKEN }}" | docker login \
            ${{ env.REGION }}.ocir.io \
            -u "${{ secrets.OCI_USER }}" \
            --password-stdin

      - name: Rollback para versão anterior
        run: |
          echo "Rollback iniciado..."
          if docker image inspect previous_backup:latest > /dev/null 2>&1; then
            docker tag previous_backup:latest ${{ env.IMAGE_BASE }}:latest
            docker push ${{ env.IMAGE_BASE }}:latest
            echo "Rollback concluído. Imagem anterior restaurada como 'latest'."
          else
            echo "Nenhuma imagem anterior encontrada. Rollback ignorado."
          fi

#name: Build & Push Docker Image with Rollback
#
#on:
#  push:
#    branches: ["main"]
#  workflow_dispatch:
#
#env:
#  APP_NAME: per2park-app-chamados
#  REGION: ${{ secrets.OCI_REGION }}
#  TENANCY: grolj6ywhill
#  IMAGE_BASE: ${{ secrets.OCI_REGION }}.ocir.io/grolj6ywhill/per2park-app-chamados
#
#jobs:
#  build-and-push:
#    runs-on: ubuntu-latest
#
#    steps:
#      - name: Checkout código
#        uses: actions/checkout@v4
#
#      - name: Configurar versão automática
#        id: version
#        run: |
#          SHORT_SHA=$(echo "${GITHUB_SHA}" | cut -c1-7)
#          VERSION="v1.0.${GITHUB_RUN_NUMBER}-${SHORT_SHA}"
#          echo "VERSION=$VERSION" >> $GITHUB_ENV
#          echo "Versão gerada: $VERSION"
#
#      - name: Configurar JDK 17
#        uses: actions/setup-java@v4
#        with:
#          java-version: '17'
#          distribution: 'temurin'
#
#      - name: Build do projeto com Maven
#        run: |
#          mvn clean package -DskipTests
#
#      - name: Login no OCIR
#        run: |
#          echo "${{ secrets.OCI_AUTH_TOKEN }}" | docker login \
#            ${{ env.REGION }}.ocir.io \
#            -u "${{ secrets.OCI_USER }}" \
#            --password-stdin
#
#      - name: Salvar versão anterior
#        id: previous
#        run: |
#          echo "Salvando imagem anterior..."
#          docker pull ${{ env.IMAGE_BASE }}:latest || echo "Sem imagem anterior"
#          docker tag ${{ env.IMAGE_BASE }}:latest previous_backup:latest || echo "Nenhuma imagem anterior para backup"
#
#      - name: Build da imagem Docker
#        run: |
#          docker build -t ${{ env.IMAGE_BASE }}:latest .
#          docker tag ${{ env.IMAGE_BASE }}:latest ${{ env.IMAGE_BASE }}:${{ env.VERSION }}
#
#      - name: Push das imagens para OCIR
#        run: |
#          docker push ${{ env.IMAGE_BASE }}:latest
#          docker push ${{ env.IMAGE_BASE }}:${{ env.VERSION }}
#
#      - name: Exibir versão final publicada
#        run: |
#          echo "Imagem publicada com sucesso:"
#          echo "${{ env.IMAGE_BASE }}:${{ env.VERSION }}"
#
#  rollback:
#    runs-on: ubuntu-latest
#    needs: build-and-push
#    if: failure()  # Só executa se o job anterior falhar
#
#    steps:
#      - name: Login no OCIR
#        run: |
#          echo "${{ secrets.OCI_AUTH_TOKEN }}" | docker login \
#            ${{ env.REGION }}.ocir.io \
#            -u "${{ secrets.OCI_USER }}" \
#            --password-stdin
#
#      - name: Rollback para versão anterior
#        run: |
#          echo "Rollback iniciado..."
#          if docker image inspect previous_backup:latest > /dev/null 2>&1; then
#            docker tag previous_backup:latest ${{ env.IMAGE_BASE }}:latest
#            docker push ${{ env.IMAGE_BASE }}:latest
#            echo "Rollback concluído. Imagem anterior restaurada como 'latest'."
#          else
#            echo "Nenhuma imagem anterior encontrada. Rollback ignorado."
#          fi
