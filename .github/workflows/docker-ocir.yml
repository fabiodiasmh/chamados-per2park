name: Build, Push & Deploy Docker Image with Rollback

on:
  push:
    branches: ["main"]
  workflow_dispatch:

env:
  APP_NAME: per2park-app-chamados
  REGION: ${{ secrets.OCI_REGION }}
  TENANCY: grolj6ywhill
  IMAGE_BASE: ${{ secrets.OCI_REGION }}.ocir.io/grolj6ywhill/per2park-app-chamados

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4

      - name: Configurar vers√£o autom√°tica
        id: version
        run: |
          SHORT_SHA=$(echo "${GITHUB_SHA}" | cut -c1-7)
          VERSION="v1.0.${GITHUB_RUN_NUMBER}-${SHORT_SHA}"
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "Vers√£o gerada: $VERSION"

      - name: Configurar JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Build do projeto com Maven
        run: |
          mvn clean package -DskipTests

      - name: Login no OCIR
        run: |
          echo "${{ secrets.OCI_AUTH_TOKEN }}" | docker login \
            ${{ env.REGION }}.ocir.io \
            -u "${{ secrets.OCI_USER }}" \
            --password-stdin

      - name: Salvar vers√£o anterior
        id: previous
        run: |
          echo "Salvando imagem anterior..."
          docker pull ${{ env.IMAGE_BASE }}:latest || echo "Sem imagem anterior"
          docker tag ${{ env.IMAGE_BASE }}:latest previous_backup:latest || echo "Nenhuma imagem anterior para backup"

      - name: Build da imagem Docker
        run: |
          docker build -t ${{ env.IMAGE_BASE }}:latest .
          docker tag ${{ env.IMAGE_BASE }}:latest ${{ env.IMAGE_BASE }}:${{ env.VERSION }}

      - name: Push das imagens para OCIR
        run: |
          docker push ${{ env.IMAGE_BASE }}:latest
          docker push ${{ env.IMAGE_BASE }}:${{ env.VERSION }}

      - name: Exibir vers√£o final publicada
        run: |
          echo "Imagem publicada com sucesso:"
          echo "${{ env.IMAGE_BASE }}:${{ env.VERSION }}"

  deploy:
    runs-on: ubuntu-latest
    needs: build-and-push

    steps:
      - name: Conectar via SSH e realizar deploy com rollback autom√°tico
        id: deploy
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            set -e
            cd /home/ubuntu/chamados-stack

            echo "=== Iniciando deploy da vers√£o ${{ env.VERSION }} ==="
            echo "${{ secrets.OCI_AUTH_TOKEN }}" | docker login \
              ${{ secrets.OCI_REGION }}.ocir.io \
              -u "${{ secrets.OCI_USER }}" \
              --password-stdin

            echo "Salvando backup da imagem atual..."
            docker pull ${{ secrets.OCI_REGION }}.ocir.io/grolj6ywhill/per2park-app-chamados:latest || true
            docker tag ${{ secrets.OCI_REGION }}.ocir.io/grolj6ywhill/per2park-app-chamados:latest backup_prev:latest || true

            echo "Atualizando containers..."
            if docker compose pull && docker compose up -d; then
              echo "‚úÖ Deploy conclu√≠do com sucesso."
              docker image prune -f
            else
              echo "‚ùå Falha no deploy. Iniciando rollback..."
              if docker image inspect backup_prev:latest > /dev/null 2>&1; then
                docker tag backup_prev:latest ${{ secrets.OCI_REGION }}.ocir.io/grolj6ywhill/per2park-app-chamados:latest
                docker compose down
                docker compose up -d
                echo "üîÅ Rollback realizado com sucesso ‚Äî sistema restaurado √† vers√£o anterior."
              else
                echo "‚ö†Ô∏è Nenhum backup encontrado para rollback."
              fi
            fi

      # ‚úÖ Envia alerta de sucesso no Telegram
      - name: Enviar alerta Telegram - sucesso
        if: success()
        run: |
          MESSAGE="‚úÖ *Deploy conclu√≠do com sucesso!*\n\nüì¶ Vers√£o: \`${{ env.VERSION }}\`\nüîó [Ver commit](https://github.com/${{ github.repository }}/commit/${{ github.sha }})"
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
            -d parse_mode=Markdown \
            -d text="$MESSAGE"

      # ‚ùå Envia alerta de falha no Telegram
      - name: Enviar alerta Telegram - falha
        if: failure()
        run: |
          MESSAGE="üö® *Falha no deploy!*\nRollback pode ter sido acionado.\n\nüì¶ Vers√£o: \`${{ env.VERSION }}\`\nüîó [Ver commit](https://github.com/${{ github.repository }}/commit/${{ github.sha }})"
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
            -d parse_mode=Markdown \
            -d text="$MESSAGE"



#name: Build & Push Docker Image with Rollback
#
#on:
#  push:
#    branches: ["main"]
#  workflow_dispatch:
#
#env:
#  APP_NAME: per2park-app-chamados
#  REGION: ${{ secrets.OCI_REGION }}
#  TENANCY: grolj6ywhill
#  IMAGE_BASE: ${{ secrets.OCI_REGION }}.ocir.io/grolj6ywhill/per2park-app-chamados
#
#jobs:
#  build-and-push:
#    runs-on: ubuntu-latest
#
#    steps:
#      - name: Checkout c√≥digo
#        uses: actions/checkout@v4
#
#      - name: Configurar vers√£o autom√°tica
#        id: version
#        run: |
#          SHORT_SHA=$(echo "${GITHUB_SHA}" | cut -c1-7)
#          VERSION="v1.0.${GITHUB_RUN_NUMBER}-${SHORT_SHA}"
#          echo "VERSION=$VERSION" >> $GITHUB_ENV
#          echo "Vers√£o gerada: $VERSION"
#
#      - name: Configurar JDK 17
#        uses: actions/setup-java@v4
#        with:
#          java-version: '17'
#          distribution: 'temurin'
#
#      - name: Build do projeto com Maven
#        run: |
#          mvn clean package -DskipTests
#
#      - name: Login no OCIR
#        run: |
#          echo "${{ secrets.OCI_AUTH_TOKEN }}" | docker login \
#            ${{ env.REGION }}.ocir.io \
#            -u "${{ secrets.OCI_USER }}" \
#            --password-stdin
#
#      - name: Salvar vers√£o anterior
#        id: previous
#        run: |
#          echo "Salvando imagem anterior..."
#          docker pull ${{ env.IMAGE_BASE }}:latest || echo "Sem imagem anterior"
#          docker tag ${{ env.IMAGE_BASE }}:latest previous_backup:latest || echo "Nenhuma imagem anterior para backup"
#
#      - name: Build da imagem Docker
#        run: |
#          docker build -t ${{ env.IMAGE_BASE }}:latest .
#          docker tag ${{ env.IMAGE_BASE }}:latest ${{ env.IMAGE_BASE }}:${{ env.VERSION }}
#
#      - name: Push das imagens para OCIR
#        run: |
#          docker push ${{ env.IMAGE_BASE }}:latest
#          docker push ${{ env.IMAGE_BASE }}:${{ env.VERSION }}
#
#      - name: Exibir vers√£o final publicada
#        run: |
#          echo "Imagem publicada com sucesso:"
#          echo "${{ env.IMAGE_BASE }}:${{ env.VERSION }}"
#
#  rollback:
#    runs-on: ubuntu-latest
#    needs: build-and-push
#    if: failure()  # S√≥ executa se o job anterior falhar
#
#    steps:
#      - name: Login no OCIR
#        run: |
#          echo "${{ secrets.OCI_AUTH_TOKEN }}" | docker login \
#            ${{ env.REGION }}.ocir.io \
#            -u "${{ secrets.OCI_USER }}" \
#            --password-stdin
#
#      - name: Rollback para vers√£o anterior
#        run: |
#          echo "Rollback iniciado..."
#          if docker image inspect previous_backup:latest > /dev/null 2>&1; then
#            docker tag previous_backup:latest ${{ env.IMAGE_BASE }}:latest
#            docker push ${{ env.IMAGE_BASE }}:latest
#            echo "Rollback conclu√≠do. Imagem anterior restaurada como 'latest'."
#          else
#            echo "Nenhuma imagem anterior encontrada. Rollback ignorado."
#          fi
