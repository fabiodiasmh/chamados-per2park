name: Build & Push Docker Image

on:
  push:
    branches: ["main"]
  workflow_dispatch:

env:
  APP_NAME: per2park-app-chamados
  REGION: ${{ secrets.OCI_REGION }}
  TENANCY: grolj6ywhill
  IMAGE_BASE: ${{ secrets.OCI_REGION }}.ocir.io/grolj6ywhill/per2park-app-chamados

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout código
        uses: actions/checkout@v4

      - name: Configurar versão automática
        id: version
        run: |
          # Gera versão com número da execução + hash curto do commit
          SHORT_SHA=$(echo "${GITHUB_SHA}" | cut -c1-7)
          VERSION="v1.0.${GITHUB_RUN_NUMBER}-${SHORT_SHA}"
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "Versão gerada: $VERSION"

      - name: Login no OCIR
        run: |
          echo "${{ secrets.OCI_AUTH_TOKEN }}" | docker login \
            ${{ env.REGION }}.ocir.io \
            -u "${{ secrets.OCI_USER }}" \
            --password-stdin

      - name: Build da imagem Docker
        run: |
          docker build -t ${{ env.IMAGE_BASE }}:latest .
          docker tag ${{ env.IMAGE_BASE }}:latest ${{ env.IMAGE_BASE }}:${{ env.VERSION }}

      - name: Push das imagens para OCIR
        run: |
          docker push ${{ env.IMAGE_BASE }}:latest
          docker push ${{ env.IMAGE_BASE }}:${{ env.VERSION }}

      - name: Exibir versão final publicada
        run: |
          echo "Imagem publicada com sucesso:"
          echo "${{ env.IMAGE_BASE }}:${{ env.VERSION }}"
