name: Rollback de Vers√£o com Alerta

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Vers√£o para restaurar (ex: v1.0.24-abc1234)"
        required: true
        type: string

env:
  APP_NAME: per2park-app-chamados
  REGION: ${{ secrets.OCI_REGION }}
  TENANCY: grolj6ywhill
  IMAGE_BASE: ${{ secrets.OCI_REGION }}.ocir.io/grolj6ywhill/per2park-app-chamados

jobs:
  rollback:
    runs-on: ubuntu-latest

    steps:
      - name: Login no OCIR
        run: |
          echo "${{ secrets.OCI_AUTH_TOKEN }}" | docker login \
            ${{ env.REGION }}.ocir.io \
            -u "${{ secrets.OCI_USER }}" \
            --password-stdin

      - name: Restaurar imagem anterior
        run: |
          VERSION="${{ github.event.inputs.version }}"
          echo "Iniciando rollback para $VERSION..."
          docker pull ${{ env.IMAGE_BASE }}:$VERSION
          docker tag ${{ env.IMAGE_BASE }}:$VERSION ${{ env.IMAGE_BASE }}:latest
          docker push ${{ env.IMAGE_BASE }}:latest
          echo "Rollback conclu√≠do. latest agora aponta para $VERSION."
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      - name: Deploy na inst√¢ncia OCI
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            cd /home/ubuntu/chamados-stack
            docker compose down
            docker compose pull
            docker compose up -d
            echo "Rollback aplicado na inst√¢ncia!"

      - name: Enviar alerta para o Telegram
        run: |
          DATA=$(date '+%d/%m/%Y %H:%M:%S')
          MESSAGE="‚ö†Ô∏è *Rollback executado com sucesso!*%0A%0Aüì¶ *Aplica√ß√£o:* \`${{ env.APP_NAME }}\`%0AüîÅ *Vers√£o restaurada:* \`${{ env.VERSION }}\`%0Aüïí *Data/Hora:* ${DATA}%0Aüåê *Host:* \`${{ secrets.OCI_HOST }}\`"
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
          -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
          -d text="$MESSAGE" \
          -d parse_mode="Markdown"
